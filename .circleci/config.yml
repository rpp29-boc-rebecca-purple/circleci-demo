version: 2.1

# Define the jobs we want to run for this project
jobs:
  pull-and-build:
    docker:
      - image: arvindr226/alpine-ssh
    steps:
      - checkout
      - run: ssh -oStrictHostKeyChecking=no -v $USER@$IP "./deploy.sh"

# Orchestrate our job run sequence
workflows:
  version: 2
  build-project:
    jobs:
      - pull-and-build:
          filters:
            branches:
              only:
                - main

deploy-prod:  
  docker:  # specify the version you desire here (you might not want node)  
  - image: circleci/node:7.10  
  steps:    
    - checkout    
    - run: ssh -oStrictHostKeyChecking=no -v $USER@$IP “./deploy_project.sh”

  workflows:  
    version: 2  
    build-and-deploy:    
      jobs:      
        - build      
        - deploy-prod:          
          filters:            
            branches:              
              only:                
                - master          
              requires:            
                  - build